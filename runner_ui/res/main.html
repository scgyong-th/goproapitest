<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ADB ì„¤ì •</title>
  <link href="ext/bootstrap.min.css" rel="stylesheet">
  <link href="main.css" rel="stylesheet">
  <script src="ext/jquery-3.7.1.min.js" ></script>
  <script>
let bridge = null
//$(document).ready(async function () {
async function connect_agw() {
    $('#adb_device').val('Trying to connect...')
    const device_id = await bridge.connect_agw()
    $('#adb_device').val(device_id)

    if (device_id) {
        await connect_ble()
    }
}
async function connect_ble() {
    info = await bridge.get_app_info()
    $('#agw_app').val(JSON.stringify(info, null, 2))

    resp = await bridge.connect_ble()
    $('#camera_device').val(JSON.stringify(resp, null, 2))
}
let percent = 0
let additional = 0
async function appendLog(line) {
    if (percent < 100) {
        additional = 0
    } else {
        additional += 1
        if (additional > 100) {
            return
        }
    }
    let $log = $('#test_log');
    let text = $log.val() + '\n' + line;
    $log.val(text);
    $log.scrollTop($log[0].scrollHeight);

    const match = line.match(/\[\s*(\d+)%\]/);

    if (match) {
        percent = parseInt(match[1], 10);
        console.log(percent); // ðŸ‘‰ 6
        updateProgress(percent)
    }
}
window.addEventListener('pywebviewready', () => {
    bridge = window.pywebview.api
    console.log("pywebview ready");
    connect_agw();
});
function updateProgress(percent) {
  const bar = document.getElementById("progress-bar");
  bar.style.width = percent + "%";
  bar.setAttribute("aria-valuenow", percent);
  bar.innerText = percent + "%";
}
  </script>
</head>
<body class="d-flex flex-column vh-100">
  <h2>Android Gateway</h2>
    <div class="d-flex align-items-center gap-2 mb-3">
        <label for="adb_device" class="form-label mb-0">Android:</label>
        <input type="text" id="adb_device" class="form-control" placeholder="Device Not Found" readonly>
        <button class="btn btn-primary" onclick="connect_agw()">Connect</button>
    </div>
    <div class="d-flex align-items-center gap-2 mb-3">
        <label for="agw_app" class="form-label mb-0">App:</label>
        <textarea id="agw_app" class="form-control" readonly></textarea>
    </div>
    <div class="d-flex align-items-center gap-2 mb-3">
        <label for="camera_device" class="form-label mb-0">Cam:</label>
        <textarea id="camera_device" class="form-control" readonly></textarea>
        <button class="btn btn-primary" onclick="connect_ble()">Connect</button>
    </div>
    <div class="d-flex align-items-center gap-2">
        <button class="btn btn-primary" onclick="bridge.run_pytest()">Start Test</button>
        <div class="progress flex-fill">
            <div id="progress-bar" class="progress-bar bg-success" 
                role="progressbar" style="width: 0%;" aria-valuenow="0"
                aria-valuemin="0" aria-valuemax="100"
            >0%</div>
        </div>
        <button class="btn btn-success" onclick="bridge.show_report()">Report</button>
    </div>
    <label for="test_log" class="form-label mb-0">Test Log:</label>
    <textarea id="test_log" class="form-control flex-grow-1" readonly></textarea>

</body>
</html>
